;; Kanata configuration
;; nikivi-inspired modifier layers — no traditional modifier chords
;;
;; Modifier keys (tap = letter, hold = modifier):
;;   e = primary modifier (Cmd on macOS, Ctrl on Windows)
;;   a = Ctrl (both platforms — terminal/vim shortcuts)
;;   q = primary modifier + Shift
;;   ; = Shift
;;   Caps Lock = Escape (tap), Ctrl (hold)
;;
;; Layer keys (tap = letter, hold = activate layer):
;;   w = App launcher (focus or start apps)
;;   f = Communication (Brave, Telegram, Discord, WhatsApp, Claude)
;;   d = Media controls (play/pause, prev/next, volume, YouTube Music)
;;   z = Zellij navigation (hjkl panes, n new, p session, xcv/6-0 quick-switch sessions, space command layer)
;;   s = Utility (p = live reload kanata config)
;;   / = Cheatsheet (show layer help popup)
;;
;; Generated by chezmoi — platform: {{ .chezmoi.os }}

(defcfg
  process-unmapped-keys yes
  danger-enable-cmd yes
)

(defvar
  tt 300  ;; tap timeout (ms) — time before hold activates
  ht 250  ;; hold timeout (ms)
)

;; Only intercept the keys we remap — everything else passes through
(defsrc
  caps esc w e a q ; z s d f t r h j k l n p = - spc x c v 6 7 8 9 0 /
)
(deflayer base
  @cap _    @wmod @emod @amod @qmod @semi @zmod @smod
  @dmod @fmod _    _                ;; d/f=layer triggers, t/r=passthrough
  _    _    _    _                   ;; hjkl
  _    _                             ;; n/p
  _    _                             ;; =/-
  _                                  ;; space
  _    _    _                        ;; x/c/v
  _    _    _    _    _              ;; 6-0
  @slmod                             ;; / = cheatsheet layer
)

(defalias
  ;; Caps Lock: tap = Escape, hold = Ctrl
  ;; Useful for vim escape and terminal Ctrl shortcuts
  cap (tap-hold-release $tt $ht esc lctl)

{{ if eq .chezmoi.os "darwin" }}
  ;; macOS: primary modifier = Cmd (lmet)
  emod (tap-hold-release $tt $ht e lmet)
  qmod (tap-hold-release $tt $ht q (multi lmet lsft))
{{ else }}
  ;; Windows/Linux: primary modifier = Ctrl (lctl)
  emod (tap-hold-release $tt $ht e lctl)
  qmod (tap-hold-release $tt $ht q (multi lctl lsft))
{{ end }}

  ;; a: tap = a, hold = Ctrl (both platforms)
  ;; For terminal shortcuts: Ctrl+C (interrupt), Ctrl+A, Ctrl+R, etc.
  amod (tap-hold-release $tt $ht a lctl)

  ;; ;: tap = ;, hold = Shift
  ;; Hold ; and press any letter for uppercase, or ; + number for symbols
  semi (tap-hold-release $tt $ht ; lsft)

  ;; z: tap = z, hold = activate Zellij layer
  zmod (tap-hold-release $tt $ht z (layer-toggle zellij))
  ;; s: tap = s, hold = activate utility layer
  smod (tap-hold-release $tt $ht s (layer-toggle util))
  ;; w: tap = w, hold = activate app launcher layer
  wmod (tap-hold-release $tt $ht w (layer-toggle apps))
  ;; f: tap = f, hold = activate communication layer
  fmod (tap-hold-release $tt $ht f (layer-toggle comm))
  ;; d: tap = d, hold = activate media layer
  dmod (tap-hold-release $tt $ht d (layer-toggle media))
  ;; /: tap = /, hold = activate cheatsheet layer
  slmod (tap-hold-release $tt $ht / (layer-toggle cheatsheet))

  ;; Zellij session quick-switch macros
  ;; Opens session manager (Alt+p), types name prefix, Enter
  ;; To add a session: copy zs1 pattern, change prefix letters
  zs1 (macro A-p 500 n e o h 200 ret)     ;; x → neohaskell
  zs2 (macro A-p 500 n e c l 200 ret)     ;; c → neclau
  zs3 (macro A-p 500 S-c S-i S-o S-s 200 ret) ;; v → CIOS
  zs4 (macro A-p 500 n h - w 200 ret)     ;; 6 → nh-website
  ;; zs5 (macro A-p 500 ... 200 ret)       ;; 7 → (unassigned)
  ;; zs6 (macro A-p 500 ... 200 ret)       ;; 8 → (unassigned)
  ;; zs7 (macro A-p 500 ... 200 ret)       ;; 9 → (unassigned)
  zs8 (macro A-p 500 d o t f 200 ret)     ;; 0 → dotfiles

  ;; ── App launcher aliases (w-mode) ────────────────────────
{{ if eq .chezmoi.os "darwin" }}
  fo-ghostty (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Ghostty)
  fo-firefox (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Firefox)
  fo-bw      (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Bitwarden)
  fo-spark   (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Spark)
  fo-tick    (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh TickTick)
  fo-actmon  (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Activity Monitor)
  fo-finder  (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Finder)
{{ else }}
  fo-ghostty (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Ghostty)
  fo-firefox (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Firefox)
  fo-bw      (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Bitwarden)
  fo-spark   (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Spark)
  fo-tick    (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 TickTick)
  fo-actmon  (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 taskmgr)
  fo-finder  (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 explorer)
{{ end }}

  ;; ── Communication aliases (f-mode) ─────────────────────
{{ if eq .chezmoi.os "darwin" }}
  fo-brave  (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Brave Browser)
  fo-tg     (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Telegram Desktop)
  fo-disc   (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Discord)
  fo-wa     (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh WhatsApp)
  fo-claude (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh Claude)
{{ else }}
  fo-brave  (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Brave)
  fo-tg     (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Telegram)
  fo-disc   (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Discord)
  fo-wa     (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 WhatsApp)
  fo-claude (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 Claude)
{{ end }}

  ;; ── Media/YouTube Music alias (d-mode) ─────────────────
{{ if eq .chezmoi.os "darwin" }}
  fo-ytm    (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/focus-or-start.sh YouTube Music)
{{ else }}
  fo-ytm    (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Focus-Or-Start.ps1 YouTube Music)
{{ end }}

  ;; ── Cheatsheet aliases (/-mode) ───────────────────────
{{ if eq .chezmoi.os "darwin" }}
  cs-w (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/show-cheatsheet.sh w)
  cs-f (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/show-cheatsheet.sh f)
  cs-d (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/show-cheatsheet.sh d)
  cs-z (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/show-cheatsheet.sh z)
  cs-s (cmd {{ .chezmoi.homeDir }}/.config/kanata/scripts/show-cheatsheet.sh s)
{{ else }}
  cs-w (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Show-Cheatsheet.ps1 w)
  cs-f (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Show-Cheatsheet.ps1 f)
  cs-d (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Show-Cheatsheet.ps1 d)
  cs-z (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Show-Cheatsheet.ps1 z)
  cs-s (cmd powershell -WindowStyle Hidden -File {{ .chezmoi.homeDir }}\.config\kanata\scripts\Show-Cheatsheet.ps1 s)
{{ end }}
)

;; ── w-mode: App launcher ─────────────────────────────────
;; Hold w, press key → focus or start app
;;   j = Ghostty     k = Firefox     r = Bitwarden
;;   d = Spark       f = TickTick    t = Activity Monitor
;;   esc = Finder
(deflayer apps
  _    @fo-finder _    _    _    _    _    _    _
  @fo-spark @fo-tick @fo-actmon @fo-bw
  _    @fo-ghostty @fo-firefox _
  _    _
  _    _
  _
  _    _    _
  _    _    _    _    _
  _                                  ;; /
)

;; ── f-mode: Communication ──────────────────────────────
;; Hold f, press key → focus communication/browser app
;;   j = Brave       h = Telegram    k = Discord
;;   l = Claude      d = WhatsApp
(deflayer comm
  _    _    _    _    _    _    _    _    _
  @fo-wa _    _    _                ;; d=WhatsApp, f/t/r=passthrough
  @fo-tg @fo-brave @fo-disc @fo-claude  ;; h=Telegram j=Brave k=Discord l=Claude
  _    _                             ;; n/p
  _    _                             ;; =/-
  _                                  ;; space
  _    _    _                        ;; x/c/v
  _    _    _    _    _              ;; 6-0
  _                                  ;; /
)

;; ── d-mode: Media controls ─────────────────────────────
;; Hold d, press key → media control (vim-spatial layout)
;;   h = prev track  j = play/pause  k = vol up
;;   l = next track  n = vol down    ; = YouTube Music
(deflayer media
  _    _    _    _    _    _    @fo-ytm _    _
  _    _    _    _                   ;; d/f/t/r
  prev pp   volu next               ;; hjkl → media controls
  vold                               ;; n → volume down
  _                                  ;; p
  _    _                             ;; =/-
  _                                  ;; space
  _    _    _                        ;; x/c/v
  _    _    _    _    _              ;; 6-0
  _                                  ;; /
)
;; ── s-mode: Utility ──────────────────────────────────────
;; Hold s, press key → utility actions
(deflayer util
  _    _    _    _    _    _    _    _    _
  _    _    _    _                   ;; d/f/t/r
  _    _    _    _                   ;; hjkl (reserved for future nav)
  _                                  ;; n
  lrld                               ;; p → live reload kanata config
  _    _                             ;; =/-
  _                                  ;; space
  _    _    _                        ;; x/c/v
  _    _    _    _    _              ;; 6-0
  _                                  ;; /
)
;; ── z-mode: Zellij navigation ─────────────────────────────
;; Hold z, press key → Zellij shortcut (no Alt/Ctrl stretching)
(deflayer zellij
  _    _    _    _    _    _    _    _    _
  _    _    _    _                   ;; d/f/t/r
  A-h  A-j  A-k  A-l                ;; hjkl → Alt+hjkl (pane nav)
  A-n                                ;; n → Alt+n (new pane)
  A-p                                ;; p → Alt+p (session manager)
  A-=  A--                           ;; =/- → Alt+=/- (resize)
  C-g                                ;; space → Ctrl+g (command layer)
  @zs1 @zs2 @zs3                    ;; x/c/v → neohaskell/neclau/CIOS
  @zs4 _    _    _    @zs8           ;; 6-0 → nh-website/_/_/_/dotfiles
  _                                  ;; /
)

;; ── /-mode: Cheatsheet ────────────────────────────────────
;; Hold /, press layer key → show cheatsheet popup
(deflayer cheatsheet
  _    _    @cs-w _    _    _    _    @cs-z @cs-s
  @cs-d @cs-f _    _               ;; d=d-mode help, f=f-mode help
  _    _    _    _                   ;; hjkl
  _    _                             ;; n/p
  _    _                             ;; =/-
  _                                  ;; space
  _    _    _                        ;; x/c/v
  _    _    _    _    _              ;; 6-0
  _                                  ;; /
)
