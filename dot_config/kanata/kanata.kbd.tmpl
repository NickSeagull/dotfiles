;; Kanata configuration
;; nikivi-inspired modifier layers — no traditional modifier chords
;;
;; Modifier keys (tap = letter, hold = modifier):
;;   e = primary modifier (Cmd on macOS, Ctrl on Windows)
;;   a = Ctrl (both platforms — terminal/vim shortcuts)
;;   q = primary modifier + Shift
;;   ; = Shift
;;   Caps Lock = Escape (tap), Ctrl (hold)
;;
;; Layer keys (tap = letter, hold = activate layer):
;;   z = Zellij navigation (hjkl panes, n new, p session, xcv/6-0 quick-switch sessions, space command layer)
;;   s = Utility (p = live reload kanata config)
;;
;; Generated by chezmoi — platform: {{ .chezmoi.os }}

(defcfg
  process-unmapped-keys yes
)

(defvar
  tt 300  ;; tap timeout (ms) — time before hold activates
  ht 250  ;; hold timeout (ms)
)

;; Only intercept the keys we remap — everything else passes through
(defsrc
  caps e a q ; z s h j k l n p = - spc x c v 6 7 8 9 0
)
(deflayer base
  @cap @emod @amod @qmod @semi @zmod @smod _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
)

(defalias
  ;; Caps Lock: tap = Escape, hold = Ctrl
  ;; Useful for vim escape and terminal Ctrl shortcuts
  cap (tap-hold-release $tt $ht esc lctl)

{{ if eq .chezmoi.os "darwin" }}
  ;; macOS: primary modifier = Cmd (lmet)
  emod (tap-hold-release $tt $ht e lmet)
  qmod (tap-hold-release $tt $ht q (multi lmet lsft))
{{ else }}
  ;; Windows/Linux: primary modifier = Ctrl (lctl)
  emod (tap-hold-release $tt $ht e lctl)
  qmod (tap-hold-release $tt $ht q (multi lctl lsft))
{{ end }}

  ;; a: tap = a, hold = Ctrl (both platforms)
  ;; For terminal shortcuts: Ctrl+C (interrupt), Ctrl+A, Ctrl+R, etc.
  amod (tap-hold-release $tt $ht a lctl)

  ;; ;: tap = ;, hold = Shift
  ;; Hold ; and press any letter for uppercase, or ; + number for symbols
  semi (tap-hold-release $tt $ht ; lsft)

  ;; z: tap = z, hold = activate Zellij layer
  zmod (tap-hold-release $tt $ht z (layer-toggle zellij))
  ;; s: tap = s, hold = activate utility layer

  ;; Zellij session quick-switch macros
  ;; Opens session manager (Alt+p), types name prefix, Enter
  ;; To add a session: copy zs1 pattern, change prefix letters
  zs1 (macro A-p 500 n e o h 200 ret)     ;; x → neohaskell
  zs2 (macro A-p 500 n e c l 200 ret)     ;; c → neclau
  zs3 (macro A-p 500 S-c S-i S-o S-s 200 ret) ;; v → CIOS
  zs4 (macro A-p 500 n h - w 200 ret)     ;; 6 → nh-website
  ;; zs5 (macro A-p 500 ... 200 ret)       ;; 7 → (unassigned)
  ;; zs6 (macro A-p 500 ... 200 ret)       ;; 8 → (unassigned)
  ;; zs7 (macro A-p 500 ... 200 ret)       ;; 9 → (unassigned)
  zs8 (macro A-p 500 d o t f 200 ret)     ;; 0 → dotfiles
  smod (tap-hold-release $tt $ht s (layer-toggle util))
)

;; ── s-mode: Utility ──────────────────────────────────────
;; Hold s, press key → utility actions
(deflayer util
  _    _    _    _    _    _    _
  _    _    _    _              ;; hjkl (reserved for future nav)
  _                             ;; n
  lrld                          ;; p → live reload kanata config
  _    _                        ;; =/-
  _                             ;; space
  _    _    _                   ;; x/c/v
  _    _    _    _    _          ;; 6-0
)
;; ── z-mode: Zellij navigation ─────────────────────────────
;; Hold z, press key → Zellij shortcut (no Alt/Ctrl stretching)
(deflayer zellij
  _    _    _    _    _    _    _
  A-h  A-j  A-k  A-l           ;; hjkl → Alt+hjkl (pane nav)
  A-n                           ;; n → Alt+n (new pane)
  A-p                           ;; p → Alt+p (session manager)
  A-=  A--                      ;; =/- → Alt+=/- (resize)
  C-g                           ;; space → Ctrl+g (command layer)
  @zs1 @zs2 @zs3                ;; x/c/v → neohaskell/neclau/CIOS
  @zs4 _    _    _    @zs8      ;; 6-0 → nh-website/_/_/_/dotfiles
)